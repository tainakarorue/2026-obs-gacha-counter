# ガチャカウンター 要件定義書

## 1. プロジェクト概要

| 項目 | 内容 |
|------|------|
| プロジェクト名 | ガチャカウンター |
| 用途 | OBS Studio のブラウザソースで使用する配信用オーバーレイ |
| 技術スタック | HTML / CSS / JavaScript (ライブラリ不使用) |
| 対象ブラウザ | OBS ブラウザソース (Chromium ベース) / Google Chrome |

---

## 2. 機能要件

### 2.1 カウント機能

| ID | 機能 | 説明 |
|----|------|------|
| F-01 | 単発ガチャ (+1) | カウントを1加算する |
| F-02 | 10連ガチャ (+10) | カウントを10加算する |
| F-03 | 10連+1ガチャ (+11) | サービス込み10連。カウントを11加算する |
| F-04 | カウント戻し (Undo) | 直前の操作を1回取り消す |
| F-05 | リセット | 全カウント・履歴を初期化する (確認ダイアログあり) |

### 2.2 表示機能

| ID | 機能 | 説明 |
|----|------|------|
| F-06 | 現在の連続回数 | 前回の獲得から現在までの回数をメインに大きく表示する |
| F-07 | 総回数表示 | これまでの累計ガチャ回数を表示する |
| F-08 | 消費クレジット表示 | 総回数 × 1連コストの消費量を自動計算して表示する (1連コスト未設定時は非表示) |
| F-09 | 天井カウンター | 天井到達までの残り回数を表示する |
| F-10 | 天井回数設定 | 天井回数を -10 / -1 / +1 / +10 のカスタムボタンまたは直接入力で設定可能 (デフォルト: 200回) |
| F-11 | 獲得履歴表示 | キャラ名付きで獲得時の回数と累計を一覧表示する |
| F-12 | 獲得サマリー | キャラ名ごとにグループ化し、獲得数と合計ガチャ回数を表示する |

### 2.3 獲得記録機能

| ID | 機能 | 説明 |
|----|------|------|
| F-13 | キャラ獲得記録 | 現在のカウントで「キャラを獲得した」ことを記録する。現在のキャラ名も一緒に保存する |

### 2.4 データ永続化

| ID | 機能 | 説明 |
|----|------|------|
| F-14 | 自動保存 | 全ての操作時に localStorage へ自動保存する |
| F-15 | 自動復元 | ページ読み込み時に localStorage から自動復元する |

### 2.5 キーボードショートカット

| キー | 操作 |
|------|------|
| `1` | 単発ガチャ (+1) |
| `2` | 10連ガチャ (+10) |
| `3` | 10連+1ガチャ (+11) |
| `Space` | キャラ獲得記録 |
| `Z` | 戻す (Undo) |
| `R` | リセット |

### 2.6 演出

| ID | 機能 | 説明 |
|----|------|------|
| F-16 | カウント変動アニメーション | 数値変更時にスケールアニメーションを再生 |
| F-17 | 獲得時エフェクト | キャラ獲得記録時に強調アニメーションと最新履歴の点滅を再生 |

---

## 3. 非機能要件

| 項目 | 内容 |
|------|------|
| 背景 | 透明 (OBS のクロマキー不要) |
| フォント | 視認性の高いゴシック体 |
| レスポンシブ | OBS ブラウザソースの幅・高さに合わせて調整可能 |
| パフォーマンス | 配信に影響を与えない軽量設計 |
| 操作性 | ブラウザで直接開いてボタン操作 / OBS では表示のみ |

---

## 4. 画面レイアウト

```
┌──────────────────────────────────┐
│     [ キャラクター名入力欄 ]        │  ← キャラ名
│         ガチャカウンター            │
├──────────────────────────────────┤
│                                  │
│          現在  75  回             │  ← メインカウンター (大)
│                                  │
│    総回数 195 回  × 1連 [160]     │  ← 総回数 + 1連コスト入力
│         消費 31,200              │  ← 消費クレジット (自動計算)
│    天井まで  5回 / 200回          │  ← 天井カウンター
│                                  │
├──────────────────────────────────┤
│  ── 獲得履歴 ──                   │
│  キャラA   45回   (累計45回目)     │  ← キャラ名付き表示
│  キャラA   75回   (累計120回目)    │
│  武器B     30回   (累計150回目)    │
│                                  │
│  ── 獲得サマリー ──               │
│  キャラA ×2    合計120回          │  ← キャラ別合算
│  武器B  ×1    合計30回           │
│                                  │
├──────────────────────────────────┤
│ [+1] [+10] [+11] [獲得!] [戻す]  │  ← 操作ボタン
│           [リセット]              │
│ 天井: [-10][-1][___][+1][+10] 回 │  ← 天井設定 (カスタムボタン)
├──────────────────────────────────┤
│  1:+1  2:+10  3:+11             │  ← ショートカット説明
│  Space:獲得  Z:戻す  R:リセット   │
└──────────────────────────────────┘
```

---

## 5. データ構造

### 5.1 localStorage に保存するデータ

```json
{
  "totalCount": 150,
  "pityLimit": 200,
  "creditPerPull": 160,
  "charName": "キャラA",
  "history": [
    { "id": 1, "totalAtGet": 45,  "pullsSinceLast": 45,  "charName": "キャラA" },
    { "id": 2, "totalAtGet": 120, "pullsSinceLast": 75,  "charName": "キャラA" },
    { "id": 3, "totalAtGet": 150, "pullsSinceLast": 30,  "charName": "武器B" }
  ],
  "undoStack": [
    { "type": "pull", "amount": 10, "totalBefore": 140 },
    { "type": "get",  "totalBefore": 150 }
  ]
}
```

### 5.2 データ説明

| フィールド | 型 | 説明 |
|-----------|------|------|
| `totalCount` | number | 累計ガチャ回数 |
| `pityLimit` | number | 天井回数 |
| `creditPerPull` | number | 1連あたりのコスト (0の場合は消費行を非表示) |
| `charName` | string | 現在のキャラクター名 |
| `history[]` | array | 獲得履歴の配列 |
| `history[].id` | number | 獲得番号 (1体目, 2体目...) |
| `history[].totalAtGet` | number | 獲得時の累計回数 |
| `history[].pullsSinceLast` | number | 前回獲得からの回数 |
| `history[].charName` | string | 獲得時のキャラクター名 (空文字の場合は「N体目」表示) |
| `undoStack[]` | array | Undo 用の操作履歴 |
| `undoStack[].type` | string | 操作種別 (`"pull"` / `"get"`) |
| `undoStack[].amount` | number | 加算した回数 (pull の場合のみ) |
| `undoStack[].totalBefore` | number | 操作前の totalCount |

---

## 6. ファイル構成

```
ガチャカウンター/
├── docs/
│   └── 要件定義書.md        ← 本ファイル
├── index.html               ← メインHTMLファイル (単体で動作)
├── css/
│   └── style.css            ← スタイルシート
└── js/
    └── app.js               ← アプリケーションロジック
```

> **注:** OBS ブラウザソースでの読み込みを考慮し、3ファイル構成とする。
> `index.html` から `css/style.css` と `js/app.js` を相対パスで読み込む。

---

## 7. 各ファイルの責務

### 7.1 `index.html`

- ドキュメント構造の定義
- 各要素の配置 (カウンター、履歴、ボタン、設定)
- CSS / JS の読み込み

### 7.2 `css/style.css`

- OBS 用の透明背景設定 (`background: transparent`)
- カウンター数値のスタイリング (フォントサイズ、色、影)
- ボタンのスタイリング
- 獲得履歴リストのスタイリング
- アニメーション定義 (`@keyframes`)
- レイアウト (Flexbox ベース)

### 7.3 `js/app.js`

- 状態管理 (totalCount, history, undoStack, pityLimit, creditPerPull, charName)
- カウント操作関数 (addPull, recordGet, undo, reset)
- 画面更新関数 (render, renderHistory, renderSummary)
- localStorage 読み書き (save / load)
- キーボードイベントリスナー
- ボタンイベントリスナー (ガチャ操作、天井 +/- ボタン、1連コスト入力)
- アニメーション制御 (flashLatest フラグによる獲得時のみ点滅)

---

## 8. 処理フロー

### 8.1 ガチャカウント追加

```
ユーザー操作 (ボタン or キー)
  → undoStack に現在の状態を保存
  → totalCount に加算
  → 画面更新 (render)
  → localStorage に保存 (save)
  → アニメーション再生
```

### 8.2 キャラ獲得記録

```
ユーザー操作 (ボタン or Space)
  → undoStack に現在の状態を保存
  → history に獲得記録を追加
    - totalAtGet: 現在の totalCount
    - pullsSinceLast: 前回獲得からの差分
    - charName: 現在の state.charName
  → 画面更新 (render)
  → localStorage に保存 (save)
  → 獲得エフェクト再生
```

### 8.3 Undo

```
ユーザー操作 (ボタン or Z)
  → undoStack から直前の操作を取り出す
  → 操作種別に応じて状態を復元
    - pull: totalCount を操作前に戻す
    - get: history から最後の記録を削除
  → 画面更新 (render)
  → localStorage に保存 (save)
```

---

## 9. OBS での使用方法

1. OBS Studio でソースの追加 →「ブラウザ」を選択
2. 「ローカルファイル」にチェックを入れる
3. `index.html` のフルパスを指定
4. 幅: `400` / 高さ: `600` (推奨、調整可)
5. 操作時は別途ブラウザで `index.html` を開き、ボタン/キーで操作する

> **注:** OBS のブラウザソースと通常ブラウザで同じ localStorage を共有しないため、
> 操作用のブラウザで開いた状態をそのままウィンドウキャプチャするか、
> OBS ブラウザソースの「操作」ボタンで直接操作することを推奨する。
